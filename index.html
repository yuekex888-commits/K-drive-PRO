<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- iOS PWA & Viewport Configuration -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- PWA Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="K-drive">
    <meta name="theme-color" content="#ffffff">

    <title>K-drive PRO - 智能规划专家</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Styles -->
    <style>
        /* 修复方案：移除 position: fixed，使用 overflow 和 overscroll-behavior 控制 */
        html {
            height: 100%;
            width: 100%;
            overflow: hidden; /* 禁止 html 滚动 */
            background-color: #f9fafb;
        }

        body { 
            height: 100%; 
            width: 100%;
            overflow: hidden; /* 禁止 body 滚动 */
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior: none; /* 关键：禁止 iOS 橡皮筋回弹，替代 position: fixed */
        }

        #root {
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            background-color: #f9fafb;
        }

        /* 滚动区域仅限于 main */
        .scroll-container {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 120px; /* 增加底部留白，防止内容被底部导航栏遮挡 */
        }

        ::-webkit-scrollbar { width: 0px; background: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* 毛玻璃效果 */
        .glass { background: rgba(255, 255, 255, 0.90); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        
        /* --- 核心适配逻辑 (修复版) --- */
        
        /* 顶部适配：Header */
        /* 使用 calc 组合：系统安全区高度(避让灵动岛) + 16px 额外间距 */
        .header-safe {
            padding-top: calc(env(safe-area-inset-top) + 16px);
            padding-bottom: 16px; /* 固定的底部 Padding */
            padding-left: 1.5rem; /* px-6 equivalent */
            padding-right: 1.5rem;
        }

        /* 底部适配：Footer Nav */
        /* 背景色会延伸到底部边缘，但内容会被 padding 顶上来 */
        .footer-safe {
            padding-bottom: calc(env(safe-area-inset-bottom) + 20px);
            padding-top: 20px;
            padding-left: 3rem; /* px-12 equivalent */
            padding-right: 3rem;
        }
        
        /* 模态框的全屏适配 */
        .modal-safe {
            padding-top: calc(env(safe-area-inset-top) + 20px);
            padding-bottom: calc(env(safe-area-inset-bottom) + 20px);
        }

        .map-container { height: 100%; width: 100%; }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none;
            width: 20px; height: 20px;
            background: #3b82f6; cursor: pointer;
            border-radius: 50%; border: 3px solid white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .custom-input:focus-within { box-shadow: 0 0 0 2px #3b82f6; background: #fff; }

        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>

    <!-- Import Map for React & Icons -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1?deps=react@18.2.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>

    <!-- Babel for in-browser TSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel" data-presets="react,typescript" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import ReactDOM from 'react-dom/client';
        import { 
            MapPin, Calendar, Clock, ChevronDown, ChevronUp, Navigation, 
            Settings as SettingsIcon, Search, Star, ArrowRight, Car, Hotel, 
            Save, Trash2, RefreshCw, Plus, Minus, Check, Map as MapIcon, 
            List as ListIcon, Layers, X, Loader2, LocateFixed, Compass, Moon, Sun, Utensils,
            Image as ImageIcon, MessageSquare, Ticket, Banknote, Watch, AlertTriangle, Heart, Eye,
            Maximize2, Users, Receipt, Camera, FolderOpen, Edit3, Play, ChefHat, Wallet, Tent, Lock, Unlock
        } from 'lucide-react';

        // --- TYPES ---
        
        const Pacing = {
          COMPACT: '紧凑',
          MODERATE: '适中',
          LEISURE: '休闲'
        };

        const AccommodationType = {
          CAR: '车住(床车)',
          HOTEL: '酒店'
        };

        const DiningMode = {
            PER_MEAL: 'per_meal',
            TOTAL: 'total'
        };

        // --- GEMINI SERVICE LOGIC ---

        const DEFAULT_SETTINGS = {
          apiKey: "sk-28c0d0093c2c4486ac3b394da91f7386",
          baseUrl: "https://api.grsai.com/v1/chat/completions",
          model: "gemini-3-pro",
          defaultHotelBudget: 500,
          defaultDiningPerPerson: 100,
          defaultDiningTotal: 2000
        };

        function getSettings() {
          try {
            const stored = localStorage.getItem('gemini_drive_settings');
            if (stored) {
              return { ...DEFAULT_SETTINGS, ...JSON.parse(stored) };
            }
          } catch (e) {
            console.warn("Failed to load settings", e);
          }
          return DEFAULT_SETTINGS;
        }

        // --- MOCK DATA GENERATORS (Fallback for when API fails) ---
        const getMockPlan = (daysCount) => {
            const mockPointsBase = [
                { name: "西湖风景名胜区", type: "attraction", arrivalTime: "09:30", duration: "4小时", ticket_price: "免费", average_cost: "0", description: "杭州最著名的景点，欲把西湖比西子，淡妆浓抹总相宜。建议步行或乘船游览。", rating: 4.9, user_ratings_total: 50000, lat: 30.25, lng: 120.15 },
                { name: "灵隐寺", type: "attraction", arrivalTime: "14:00", duration: "2.5小时", ticket_price: "¥75", average_cost: "0", description: "千年古刹，环境清幽，是祈福拜佛的圣地。需购买飞来峰门票。", rating: 4.7, user_ratings_total: 20000, lat: 30.24, lng: 120.10 },
                { name: "知味观·味庄", type: "restaurant", arrivalTime: "17:30", duration: "1.5小时", ticket_price: "", average_cost: "180", description: "杭州老字号，位于杨公堤，环境优美，杭帮菜正宗。", rating: 4.5, user_ratings_total: 8000, lat: 30.245, lng: 120.14 },
                { name: "龙井村", type: "attraction", arrivalTime: "10:00", duration: "2小时", ticket_price: "免费", average_cost: "0", description: "西湖龙井茶的一级产区，茶园风光旖旎，适合拍照。", rating: 4.6, user_ratings_total: 5000, lat: 30.22, lng: 120.11 }
            ];

            return JSON.stringify({
                title: "江南风情·深度自驾之旅 (离线演示)",
                days: Array.from({ length: daysCount }, (_, i) => {
                    // Create variations of points for each day to make it look realistic
                    const dayPoints = mockPointsBase.map((p, idx) => ({
                        ...p,
                        name: i === 0 ? p.name : idx % 2 === 0 ? "宋城千古情" : "西溪国家湿地公园",
                        description: i === 0 ? p.description : "体验杭州的文化底蕴与自然风光，享受悠闲假期。",
                        arrivalTime: p.arrivalTime,
                        type: p.type
                    }));
                    
                    return {
                        day: i + 1,
                        date: new Date(Date.now() + i * 86400000).toISOString().split('T')[0],
                        transportation_cost: i === 0 ? "¥120" : "¥50",
                        points: dayPoints
                    };
                })
            });
        };

        const getMockAlternatives = () => {
            return JSON.stringify({
                alternatives: [
                    { name: "新白鹿餐厅(西湖店)", type: "restaurant", rating: 4.6, user_ratings_total: 12000, description: "性价比极高的杭帮菜，蛋黄鸡翅必点。", lat: 30.26, lng: 120.16, ticket_price: "", average_cost: "¥60", duration: "1h" },
                    { name: "外婆家(湖滨店)", type: "restaurant", rating: 4.5, user_ratings_total: 15000, description: "国民餐厅，茶香鸡非常入味，排队较多。", lat: 30.27, lng: 120.17, ticket_price: "", average_cost: "¥70", duration: "1h" },
                    { name: "楼外楼(孤山路店)", type: "restaurant", rating: 4.3, user_ratings_total: 8000, description: "百年老店，西湖醋鱼的发源地，就在西湖边。", lat: 30.255, lng: 120.155, ticket_price: "", average_cost: "¥220", duration: "1.5h" }
                ]
            });
        };

        async function callOpenAICompatible(messages, jsonMode = true) {
          const settings = getSettings();
          const url = settings.baseUrl;

          const body = {
            model: settings.model,
            messages: messages,
            stream: false,
            max_tokens: 8192,
            temperature: 0.7
          };

          if (jsonMode) {
            body.response_format = { type: "json_object" };
          }

          try {
            const response = await fetch(url, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${settings.apiKey}`
              },
              body: JSON.stringify(body)
            });

            if (!response.ok) {
              const errText = await response.text();
              throw new Error(`API Request Failed: ${response.status} - ${errText}`);
            }

            const data = await response.json();
            const content = data.choices?.[0]?.message?.content || "";
            if (!content) throw new Error("Empty response from AI");
            return content;
          } catch (error) {
            console.error("API Call Error, switching to MOCK mode:", error);
            
            // Heuristic to guess intent from the last message content
            const lastMsgContent = messages[messages.length - 1].content;
            
            // Simulate network delay for realism
            await new Promise(resolve => setTimeout(resolve, 1500));

            if (lastMsgContent.includes("self-driving itinerary")) {
                alert("⚠️ 注意：API 连接失败 (可能由于网络或 Key 限制)。\n\n已为您切换至【离线演示模式】，展示模拟数据。");
                // Extract days count from prompt if possible, default to 3
                const daysMatch = lastMsgContent.match(/(\d+)-day/);
                const days = daysMatch ? parseInt(daysMatch[1]) : 3;
                return getMockPlan(days);
            } 
            else if (lastMsgContent.includes("Find alternatives")) {
                return getMockAlternatives();
            }
            else if (lastMsgContent.includes("Recommend destinations")) {
                return JSON.stringify(["苏州", "南京", "无锡", "千岛湖", "莫干山"]);
            }

            throw error; // Rethrow if we can't handle it
          }
        }

        function extractJson(text) {
          let jsonString = text.trim();
          const codeBlockMatch = jsonString.match(new RegExp("\\x60{3}(?:json)?\\s*([\\s\\S]*?)\\x60{3}"));
          if (codeBlockMatch && codeBlockMatch[1]) {
            jsonString = codeBlockMatch[1].trim();
          }
          jsonString = jsonString.replace(/(^|[^:])\/\/.*$/gm, '$1');
          
          const firstOpen = jsonString.search(/[\{\[]/);
          if (firstOpen !== -1) {
            jsonString = jsonString.substring(firstOpen);
          }
          
          try {
            return JSON.parse(jsonString);
          } catch (e) {
            // Repair logic omitted for brevity, assuming standard JSON output or basic repair
            // In a full implementation, keep the complex repair logic
          }
           try {
            const stack = [];
            let inString = false;
            let isEscaped = false;
            for (let i = 0; i < jsonString.length; i++) {
              const char = jsonString[i];
              if (isEscaped) { isEscaped = false; continue; }
              if (char === '\\') { isEscaped = true; continue; }
              if (char === '"') { inString = !inString; }
              if (!inString) {
                if (char === '{') stack.push('}');
                else if (char === '[') stack.push(']');
                else if (char === '}' || char === ']') {
                  const expected = stack[stack.length - 1];
                  if (char === expected) stack.pop();
                }
              }
            }
            if (inString) { jsonString += '"'; }
            jsonString = jsonString.replace(/,\s*$/, '');
            while (stack.length > 0) { jsonString += stack.pop(); }
            jsonString = jsonString.replace(/,\s*([\}\]])/g, '$1');
            return JSON.parse(jsonString);
          } catch (e) {
            console.error("JSON Repair failed", e);
            throw new Error("AI output was incomplete or invalid. Please try reducing the number of days.");
          }
        }

        async function generateTravelPlan(params) {
          const { 
              start, end, startTime, endTime, days, travelers, isRoundTrip, pacing, 
              includeAccom, accommodationType, hotelBudget, 
              mustVisit, avoid,
              diningMode, diningPerPerson, diningTotal
          } = params;

          let diningInstruction = "";
          if (diningMode === DiningMode.TOTAL) {
              diningInstruction = `
              - **DINING STRATEGY (CRITICAL)**: Total dining budget for ALL travelers is limited to ${diningTotal} CNY.
              - **SMART ALLOCATION**: Do NOT spend evenly. 
              - Plan mostly cost-effective local snacks/noodles (avg 30-50 CNY/person) for lunches.
              - Save budget to include 1-3 Premium/Black Pearl/Michelin dining experiences (300-500+ CNY) at peak moments. 
              `;
          } else {
              diningInstruction = `- **DINING BUDGET**: Average approx ${diningPerPerson} CNY per person per meal.`;
          }

          let accomInstruction = "";
          if (includeAccom) {
              if (accommodationType === AccommodationType.HOTEL) {
                  accomInstruction = `Accom: Hotel (Budget ~${hotelBudget} CNY/night).`;
              } else {
                  accomInstruction = `
                  - **ACCOMMODATION (BED CAR / SLEEPING IN CAR)**: 
                  - **TARGET**: Find **Underground Parking Lots** (preferred for stable temp) or safe 24h Public Parking suitable for stealth camping/sleeping in vehicle.
                  - **COST**: Priority on **FREE** or very cheap parking.
                  - **STRICTLY FORBIDDEN**: Do NOT suggest RV Campsites (房车营地) or Hotels. User is in a converted normal car.
                  `;
              }
          } else {
              accomInstruction = "Accom: None needed.";
          }

          const systemInstruction = `You are a Senior Luxury Travel Consultant & Local Expert for China.
          **YOUR GOAL**: Design a "Travel Experience", NOT just a navigation route.
          **PRIORITY**: Quality of Attractions > Food Quality > Scenic Route > Distance Efficiency.
          **LANGUAGE**: **STRICTLY SIMPLIFIED CHINESE (简体中文)**.

          **STRICT RULES**:
          1. Must-Visit: National 5A/4A Tourist Attractions.
          2. Store Names: Exact Chinese names.
          3. Smart Detours: Maximize scenery.
          
          **USER REQUIREMENTS**:
          ${mustVisit && mustVisit.length > 0 ? `- MUST VISIT: ${mustVisit.join(', ')}.` : ''}
          ${avoid && avoid.length > 0 ? `- AVOID: ${avoid.join(', ')}.` : ''}

          **SCHEDULE**:
          1. Timezone: UTC+8.
          2. Trip: [${startTime}] to [${endTime}].
          3. Sleep: 23:00 - 08:00 (No travel).

          **PREFERENCES**:
          Travelers: ${travelers}. Pacing: ${pacing}. Round Trip: ${isRoundTrip}.
          ${accomInstruction}
          ${diningInstruction}

          **OUTPUT**: JSON Only.
          {
            "title": "string (Creative Chinese Title)",
            "days": [
              { "day": number, "date": "YYYY-MM-DD", "transportation_cost": "string (e.g. '¥200')", "points": [ { "name": "string (Chinese Name)", "type": "attraction" | "restaurant" | "parking" | "hotel", "arrivalTime": "HH:mm", "duration": "string", "ticket_price": "string", "average_cost": "string", "description": "string (In Chinese, mention budget status if applicable)", "rating": number, "user_ratings_total": number, "lat": number, "lng": number, "travelTimeToNext": "string" } ] }
            ]
          }`;

          const userPrompt = `Design a premium ${days}-day self-driving itinerary from ${start} to ${end}. Start: ${startTime}, End: ${endTime}. Travelers: ${travelers}. Focus on 5A/4A attractions. Return entirely in Simplified Chinese.`;

          const responseText = await callOpenAICompatible([
            { role: "system", content: systemInstruction },
            { role: "user", content: userPrompt }
          ]);
          const data = extractJson(responseText);
          return { id: Date.now().toString(), ...params, startPoint: start, endPoint: end, title: data.title || `${start} - ${end} 深度自驾`, durationDays: days, days: data.days || [], mustVisit, avoid };
        }

        async function getAlternativePoints(pointName, type, context = {}) {
          const { hotelBudget, diningPerPerson, diningMode, accommodationType } = context;

          let typeInstruction = "";
          
          if (type === 'hotel') {
              typeInstruction = `CRITICAL REQUIREMENT: The alternatives MUST be **HOTELS** (Accommodation). BUDGET ~${hotelBudget || 500} CNY.`;
          } else if (type === 'restaurant') {
              let budgetText = diningMode === 'per_meal' ? `BUDGET: ~${diningPerPerson} CNY/person.` : `BUDGET: Mix of value and premium.`;
              typeInstruction = `CRITICAL REQUIREMENT: The alternatives MUST be **RESTAURANTS**. ${budgetText}`;
          } else if (type === 'parking') {
              typeInstruction = `CRITICAL REQUIREMENT: **Underground Parking Lots** or Safe Public Parking for Bed Car. NO RV CAMPS.`;
          } else {
              typeInstruction = `Find 5 alternative Top-Tier (>4.5 rating) places of type "${type}".`;
          }

          const systemInstruction = `You are a travel assistant finding replacements.
          Original Point: "${pointName}". Target Type: "${type}".
          ${typeInstruction}
          Language: **STRICTLY SIMPLIFIED CHINESE**.
          Output JSON Array: [{"name", "rating", "user_ratings_total", "description", "lat", "lng", "ticket_price", "average_cost", "duration"}]`;
          
          const responseText = await callOpenAICompatible([ { role: "system", content: systemInstruction }, { role: "user", content: "Find alternatives." } ]);
          const data = extractJson(responseText);
          return Array.isArray(data) ? data : (data.alternatives || []);
        }

        async function recommendDestinations(currentLocation) {
          const systemInstruction = `Recommend 5 High-Quality self-driving destinations >300km from ${currentLocation}. Language: **SIMPLIFIED CHINESE**. Output JSON Array: ["City1", "City2"...]`;
          const responseText = await callOpenAICompatible([ { role: "system", content: systemInstruction }, { role: "user", content: "Recommend destinations." } ]);
          const data = extractJson(responseText);
          return Array.isArray(data) ? data : [];
        }

        // --- APP COMPONENT ---

        class RequestQueue {
          constructor() { this.queue = []; this.activeCount = 0; this.maxConcurrent = 2; }
          add(fn) { this.queue.push(fn); this.process(); }
          async process() {
            if (this.activeCount >= this.maxConcurrent || this.queue.length === 0) return;
            this.activeCount++;
            const fn = this.queue.shift();
            if (fn) { try { await fn(); } catch (e) { console.error("Task failed", e); } finally { this.activeCount--; this.process(); } }
          }
        }
        const requestQueue = new RequestQueue();

        const formatBeijingDate = (date) => {
          const utc = date.getTime() + (date.getTimezoneOffset() * 60000);
          const beijingOffset = 8 * 60 * 60 * 1000;
          const beijingDate = new Date(utc + beijingOffset);
          const pad = (n) => n.toString().padStart(2, '0');
          return `${beijingDate.getFullYear()}-${pad(beijingDate.getMonth() + 1)}-${pad(beijingDate.getDate())}T${pad(beijingDate.getHours())}:${pad(beijingDate.getMinutes())}`;
        };

        const parsePrice = (priceStr) => {
          if (!priceStr) return 0;
          const match = priceStr.match(/(\d+)/);
          return match ? parseInt(match[1], 10) : 0;
        };

        const calculatePointCost = (pt, travelers) => {
          let cost = 0;
          if (pt.ticket_price && !pt.ticket_price.includes("免费")) cost += parsePrice(pt.ticket_price) * travelers;
          if (pt.average_cost && !pt.average_cost.includes("免费")) {
             const price = parsePrice(pt.average_cost);
             if (pt.type === 'hotel') cost += price * Math.ceil(travelers / 2);
             else cost += price * travelers;
          }
          if (pt.type === 'parking' && pt.ticket_price) cost += parsePrice(pt.ticket_price);
          return cost;
        };

        const getRealImages = (name, type) => {
          const keywords = ['高清大图', '景色', type === 'restaurant' ? '美食' : '摄影', '旅游'];
          return keywords.map((kw, i) => `https://tse${(i % 4) + 1}.mm.bing.net/th?q=${encodeURIComponent(name + ' ' + kw)}&w=800&h=600&c=7&rs=1`);
        };

        // --- WAKE LOCK HOOK FOR BUG 3 ---
        const useWakeLock = () => {
            const wakeLock = useRef(null);
            const [isLocked, setIsLocked] = useState(false);
            const [isSupported, setIsSupported] = useState(false);

            useEffect(() => {
                // Check if browser supports Wake Lock
                if ('wakeLock' in navigator) {
                    setIsSupported(true);
                }
            }, []);

            const requestLock = async () => {
                if (!isSupported) return;
                try {
                    wakeLock.current = await navigator.wakeLock.request('screen');
                    setIsLocked(true);
                    console.log('Wake Lock active');
                    
                    wakeLock.current.addEventListener('release', () => {
                        console.log('Wake Lock released');
                        setIsLocked(false);
                    });
                } catch (err) {
                    // Suppress "NotAllowedError" (Policy blocked) to prevent alarming console error
                    // But we track state so UI can warn user
                    if (err.name === 'NotAllowedError') {
                        console.warn('Wake Lock not allowed by system permission policy.');
                    } else {
                        console.warn('Wake Lock request failed:', err.name, err.message);
                    }
                    setIsLocked(false);
                }
            };

            const releaseLock = async () => {
                if (wakeLock.current) {
                    try {
                        await wakeLock.current.release();
                        wakeLock.current = null;
                    } catch (err) {
                        console.warn('Wake Lock release failed:', err);
                    }
                }
                setIsLocked(false);
            };

            // Cleanup on unmount
            useEffect(() => {
                return () => {
                    releaseLock();
                };
            }, []);

            return { requestLock, releaseLock, isLocked, isSupported };
        };

        const App = () => {
          const initialSettings = getSettings();
          const { requestLock, releaseLock, isLocked, isSupported } = useWakeLock();

          const [isFormExpanded, setIsFormExpanded] = useState(true);
          const [isLoading, setIsLoading] = useState(false);
          const [plan, setPlan] = useState(null);
          const [savedPlans, setSavedPlans] = useState([]);
          const [viewMode, setViewMode] = useState('list');
          
          const [selectedPoint, setSelectedPoint] = useState(null);
          const [lightboxImage, setLightboxImage] = useState(null);

          const [showAlternatives, setShowAlternatives] = useState(null);
          const [alternatives, setAlternatives] = useState([]);
          const [isLoadingAlts, setIsLoadingAlts] = useState(false);
          
          const [isLocating, setIsLocating] = useState(false);
          const [recommendedDestinations, setRecommendedDestinations] = useState([]);
          const [isLoadingRecs, setIsLoadingRecs] = useState(false);

          const [showSettings, setShowSettings] = useState(false);
          const [showHistory, setShowHistory] = useState(false); 
          const [editingPlanId, setEditingPlanId] = useState(null);
          const [editTitle, setEditTitle] = useState("");

          const [settings, setSettings] = useState(initialSettings);

          const [start, setStart] = useState('上海');
          const [end, setEnd] = useState('杭州');
          const [days, setDays] = useState(3);
          const [travelers, setTravelers] = useState(2);
          const [startTime, setStartTime] = useState(formatBeijingDate(new Date()));
          const [endTime, setEndTime] = useState(() => {
            const d = new Date();
            d.setDate(d.getDate() + 3);
            return formatBeijingDate(d);
          });
          const [isRoundTrip, setIsRoundTrip] = useState(true);
          const [pacing, setPacing] = useState(Pacing.MODERATE);
          const [includeAccom, setIncludeAccom] = useState(true);
          const [accommodationType, setAccommodationType] = useState(AccommodationType.HOTEL);
          
          const [hotelBudget, setHotelBudget] = useState(initialSettings.defaultHotelBudget);
          const [diningMode, setDiningMode] = useState(DiningMode.PER_MEAL);
          const [diningPerPerson, setDiningPerPerson] = useState(initialSettings.defaultDiningPerPerson);
          const [diningTotal, setDiningTotal] = useState(initialSettings.defaultDiningTotal);

          const [mustVisitInput, setMustVisitInput] = useState("");
          const [mustVisitList, setMustVisitList] = useState([]);
          const [avoidInput, setAvoidInput] = useState("");
          const [avoidList, setAvoidList] = useState([]);

          useEffect(() => {
            const history = localStorage.getItem('gemini_drive_history');
            if (history) setSavedPlans(JSON.parse(history));
          }, []);

          const saveSettings = () => { 
              localStorage.setItem('gemini_drive_settings', JSON.stringify(settings)); 
              setShowSettings(false); 
              alert("设置已保存！新的默认预算将在下次刷新或新规划时生效。"); 
          };

          const addMustVisit = () => { if (mustVisitInput.trim()) { setMustVisitList([...mustVisitList, mustVisitInput.trim()]); setMustVisitInput(""); } };
          const removeMustVisit = (idx) => { setMustVisitList(mustVisitList.filter((_, i) => i !== idx)); };
          const addAvoid = () => { if (avoidInput.trim()) { setAvoidList([...avoidList, avoidInput.trim()]); setAvoidInput(""); } };
          const removeAvoid = (idx) => { setAvoidList(avoidList.filter((_, i) => i !== idx)); };

          const saveCurrentPlan = () => {
             if (!plan) return;
             const existingIdx = savedPlans.findIndex(p => p.id === plan.id);
             let newHistory;
             if (existingIdx >= 0) {
                 newHistory = [...savedPlans];
                 newHistory[existingIdx] = plan;
             } else {
                 newHistory = [plan, ...savedPlans];
             }
             setSavedPlans(newHistory);
             localStorage.setItem('gemini_drive_history', JSON.stringify(newHistory));
             alert("方案已保存至“我的行程”");
          };

          const deletePlan = (e, id) => {
             e.stopPropagation();
             if(!confirm("确定要删除这个行程吗？")) return;
             const newHistory = savedPlans.filter(p => p.id !== id);
             setSavedPlans(newHistory);
             localStorage.setItem('gemini_drive_history', JSON.stringify(newHistory));
             if (plan && plan.id === id) setPlan(null);
          };

          const loadPlan = (p) => {
             setPlan(p);
             setStart(p.startPoint);
             setEnd(p.endPoint);
             setDays(p.durationDays);
             setMustVisitList(p.mustVisit || []);
             setAvoidList(p.avoid || []);
             setShowHistory(false);
          };

          const startRenaming = (e, p) => { e.stopPropagation(); setEditingPlanId(p.id); setEditTitle(p.title); };
          const saveRename = (e, id) => {
             e.stopPropagation();
             const newHistory = savedPlans.map(p => p.id === id ? { ...p, title: editTitle } : p);
             setSavedPlans(newHistory);
             localStorage.setItem('gemini_drive_history', JSON.stringify(newHistory));
             if (plan && plan.id === id) setPlan({ ...plan, title: editTitle });
             setEditingPlanId(null);
          };

          const calculateDaysDiff = (s, e) => {
            const startD = new Date(s);
            const endD = new Date(e);
            if (isNaN(startD.getTime()) || isNaN(endD.getTime())) return 1;
            const diff = endD.getTime() - startD.getTime();
            return Math.max(1, Math.ceil(diff / (1000 * 60 * 60 * 24)));
          };
          const calculateEndTimeFromDays = (startStr, numDays) => {
            const s = new Date(startStr);
            const e = new Date(s.getTime() + numDays * 24 * 60 * 60 * 1000);
            return formatBeijingDate(e);
          };
          const handleStartTimeChange = (val) => { setStartTime(val); setEndTime(calculateEndTimeFromDays(val, days)); };
          const handleEndTimeChange = (val) => { setEndTime(val); setDays(calculateDaysDiff(startTime, val)); };
          const handleDaysChange = (newDays) => { const d = Math.max(1, newDays); setDays(d); setEndTime(calculateEndTimeFromDays(startTime, d)); };

          const handleTimePreset = (target, type) => {
            const currentVal = target === 'start' ? startTime : endTime;
            let dateObj = new Date(currentVal);
            if(isNaN(dateObj.getTime())) dateObj = new Date();
            const now = new Date();
            let newStr = "";
            if (type === 'now') { newStr = formatBeijingDate(now); } else {
                let h = 12, m = 0;
                if (type === 'dinner') h = 18; if (type === 'night') h = 23;
                dateObj.setHours(h, m);
                newStr = formatBeijingDate(dateObj);
            }
            if (target === 'start') {
                const newStartDt = new Date(newStr);
                const currentEndDt = new Date(endTime);
                if (newStartDt < currentEndDt) { setStartTime(newStr); setDays(calculateDaysDiff(newStr, endTime)); } else { setStartTime(newStr); setEndTime(calculateEndTimeFromDays(newStr, days)); }
            } else { setEndTime(newStr); setDays(calculateDaysDiff(startTime, newStr)); }
          };

          const handleLocateMe = () => {
            if (!navigator.geolocation) { alert("不支持定位"); return; }
            setIsLocating(true);
            const success = (position) => {
              const { latitude, longitude } = position.coords;
              const latLngStr = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
              setStart(latLngStr);
              fetchRecommendations("中国");
              setIsLocating(false);
            };
            const error = () => { alert("定位失败，请检查权限"); setIsLocating(false); };
            navigator.geolocation.getCurrentPosition(success, error);
          };

          const fetchRecommendations = async (origin) => {
            setIsLoadingRecs(true);
            try { const recs = await recommendDestinations(origin); setRecommendedDestinations(recs); } catch (e) { console.error(e); } finally { setIsLoadingRecs(false); }
          };

          const handleGenerate = async () => {
            setIsLoading(true);
            await requestLock(); // Try to get wake lock
            try {
              const newPlan = await generateTravelPlan({ 
                  start, end, startTime, endTime, days, travelers, isRoundTrip, pacing, 
                  includeAccom, accommodationType, hotelBudget, 
                  mustVisit: mustVisitList, avoid: avoidList,
                  diningMode, diningPerPerson, diningTotal 
              });
              setPlan(newPlan);
              setIsFormExpanded(false);
              prefetchAlternatives(newPlan);
            } catch (e) { alert("生成失败: " + e.message); } finally { 
                setIsLoading(false);
                releaseLock(); 
            }
          };

          const prefetchAlternatives = (currentPlan) => {
            const context = {
                hotelBudget: currentPlan.hotelBudget,
                diningPerPerson: currentPlan.diningPerPerson,
                diningMode: currentPlan.diningMode,
                accommodationType: currentPlan.accommodationType 
            };
            currentPlan.days.forEach((day, dIdx) => {
              day.points.forEach((point, pIdx) => {
                requestQueue.add(async () => {
                  try {
                      const alts = await getAlternativePoints(point.name, point.type, context);
                      setPlan(prevPlan => {
                        if (!prevPlan) return null;
                        const newDays = [...prevPlan.days];
                        if (newDays[dIdx] && newDays[dIdx].points[pIdx]) {
                           const newPoints = [...newDays[dIdx].points];
                           newPoints[pIdx] = { ...newPoints[pIdx], alternatives: alts };
                           newDays[dIdx] = { ...newDays[dIdx], points: newPoints };
                        }
                        return { ...prevPlan, days: newDays };
                      });
                  } catch(err) { console.warn(`Failed to fetch alternatives for ${point.name}`, err); }
                });
              });
            });
          };

          const handlePointClick = (pt) => { setSelectedPoint(pt); };
          const handleReplaceClick = (e, pt, dIdx, pIdx) => {
            e.stopPropagation();
            const context = {
                hotelBudget: plan.hotelBudget,
                diningPerPerson: plan.diningPerPerson,
                diningMode: plan.diningMode,
                accommodationType: plan.accommodationType
            };
            if (pt.alternatives && pt.alternatives.length > 0) {
              setAlternatives(pt.alternatives);
              setShowAlternatives({ point: pt, dayIdx: dIdx, pointIdx: pIdx });
            } else {
              setShowAlternatives({ point: pt, dayIdx: dIdx, pointIdx: pIdx });
              setIsLoadingAlts(true);
              getAlternativePoints(pt.name, pt.type, context).then(alts => {
                 setAlternatives(alts);
                 setIsLoadingAlts(false);
                 setPlan(prev => {
                     if (!prev) return null;
                     const newDays = [...prev.days];
                     const newPoints = [...newDays[dIdx].points];
                     newPoints[pIdx] = { ...newPoints[pIdx], alternatives: alts };
                     newDays[dIdx] = { ...newDays[dIdx], points: newPoints };
                     return { ...prev, days: newDays };
                 });
              });
            }
          };

          const confirmReplace = (alt) => {
            if (!showAlternatives || !plan) return;
            const context = {
                hotelBudget: plan.hotelBudget,
                diningPerPerson: plan.diningPerPerson,
                diningMode: plan.diningMode,
                accommodationType: plan.accommodationType
            };
            const { dayIdx, pointIdx } = showAlternatives;
            const newPlan = { ...plan };
            const oldPoint = newPlan.days[dayIdx].points[pointIdx];
            const newPoint = { ...oldPoint, ...alt, alternatives: [], photos: [], reviews: [] };
            const newDays = [...newPlan.days];
            newDays[dayIdx].points[pointIdx] = newPoint;
            setPlan({ ...newPlan, days: newDays });
            setShowAlternatives(null);
            setAlternatives([]);
            requestQueue.add(async () => {
                  const alts = await getAlternativePoints(newPoint.name, newPoint.type, context);
                  setPlan(curr => { if(!curr) return null; const d = [...curr.days]; d[dayIdx].points[pointIdx].alternatives = alts; return { ...curr, days: d }; })
            });
          };

          const getMapSrc = () => {
            if (!plan || plan.days.length === 0) return "";
            const points = plan.days.flatMap(d => d.points);
            if (points.length < 2) return "";
            const origin = `${points[0].lat},${points[0].lng}`;
            // Use slicing to avoid URL length limits if too many points, take key stops
            const daddr = points.slice(1).map(p => `${p.lat},${p.lng}`).join('+to:');
            return `https://maps.google.com/maps?saddr=${origin}&daddr=${daddr}&ie=UTF8&output=embed`;
          };

          const calculateTotalCost = (p) => {
             let total = 0, transport = 0, accom = 0, dining = 0, tickets = 0;
             p.days.forEach(day => {
                if (day.transportation_cost) { const tCost = parsePrice(day.transportation_cost); total += tCost; transport += tCost; }
                day.points.forEach(pt => {
                    const cost = calculatePointCost(pt, p.travelers); total += cost;
                    if (pt.type === 'hotel') accom += cost; else if (pt.type === 'restaurant') dining += cost; else if (pt.type === 'attraction') tickets += cost; else if (pt.type === 'parking') transport += cost;
                });
             });
             return { total, transport, accom, dining, tickets };
          };

          const QuickTimeButtons = ({ target }) => (
            <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1 mt-2">
              <button onClick={() => handleTimePreset(target, 'now')} className="px-3 py-1.5 bg-blue-50 text-blue-600 rounded-lg text-xs font-bold whitespace-nowrap border border-blue-100">现在</button>
              <button onClick={() => handleTimePreset(target, 'noon')} className="px-3 py-1.5 bg-gray-50 text-gray-600 rounded-lg text-xs font-bold whitespace-nowrap flex items-center gap-1 border border-gray-100 hover:bg-white hover:border-gray-300"><Sun className="w-3 h-3 text-orange-400"/>12:00</button>
              <button onClick={() => handleTimePreset(target, 'dinner')} className="px-3 py-1.5 bg-gray-50 text-gray-600 rounded-lg text-xs font-bold whitespace-nowrap flex items-center gap-1 border border-gray-100 hover:bg-white hover:border-gray-300"><Utensils className="w-3 h-3 text-red-400"/>18:00</button>
              <button onClick={() => handleTimePreset(target, 'night')} className="px-3 py-1.5 bg-gray-50 text-gray-600 rounded-lg text-xs font-bold whitespace-nowrap flex items-center gap-1 border border-gray-100 hover:bg-white hover:border-gray-300"><Moon className="w-3 h-3 text-indigo-400"/>23:00</button>
            </div>
          );

          const CostSummary = ({ plan }) => {
             const costs = calculateTotalCost(plan);
             return (
               <div className="mx-5 mb-8 p-5 bg-gradient-to-br from-gray-900 to-gray-800 rounded-[32px] text-white shadow-xl">
                  <div className="flex items-center justify-between mb-4"><div className="flex items-center gap-2"><Receipt className="w-5 h-5 text-yellow-400"/><h3 className="font-bold">行程预算总览 ({plan.travelers}人)</h3></div><span className="text-2xl font-bold text-yellow-400">¥{costs.total}</span></div>
                  <div className="grid grid-cols-2 gap-3 text-xs">
                     <div className="bg-white/10 p-3 rounded-2xl flex justify-between items-center"><span className="text-gray-300">过路费/油费</span><span className="font-bold">¥{costs.transport}</span></div>
                     <div className="bg-white/10 p-3 rounded-2xl flex justify-between items-center"><span className="text-gray-300">住宿费用</span><span className="font-bold">¥{costs.accom}</span></div>
                     <div className="bg-white/10 p-3 rounded-2xl flex justify-between items-center"><span className="text-gray-300">餐饮美食</span><span className="font-bold">¥{costs.dining}</span></div>
                     <div className="bg-white/10 p-3 rounded-2xl flex justify-between items-center"><span className="text-gray-300">门票活动</span><span className="font-bold">¥{costs.tickets}</span></div>
                  </div>
                  <div className="mt-4 pt-4 border-t border-white/10 text-center text-xs text-gray-400">人均约 ¥{Math.round(costs.total / plan.travelers)}</div>
               </div>
             );
          };

          /* BUG 1 & 2 FIX: Refactored Layout Structure */
          return (
            <div className="flex flex-col h-full w-full relative bg-gray-50">
              {/* Header - Fixed to top of flex container */}
              <header 
                className="flex-none px-6 py-5 flex items-center justify-between bg-white/80 backdrop-blur-lg z-30 border-b border-gray-100 transition-all safe-top"
              >
                <div className="flex items-center gap-2">
                  <div className="w-8 h-8 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-200"><Compass className="text-white w-5 h-5" /></div>
                  <h1 className="font-bold text-lg text-gray-800 tracking-tight">K-drive PRO</h1>
                </div>
                <div className="flex items-center gap-1">
                    <button onClick={() => setShowHistory(true)} className="p-2 text-gray-400 hover:text-blue-600 transition-colors"><FolderOpen className="w-5 h-5" /></button>
                    <button onClick={() => setShowSettings(true)} className="p-2 text-gray-400 hover:text-blue-600 transition-colors"><SettingsIcon className="w-5 h-5" /></button>
                </div>
              </header>

              {/* Main Content - Scrollable Area */}
              <main className="scroll-container">
                 {/* Modals placed here are fixed relative to window */}
                 
                 {showHistory && (
                 <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-6 animate-in fade-in duration-200 safe-top safe-bottom">
                    <div className="bg-white w-full rounded-[32px] p-6 shadow-2xl animate-in zoom-in-95 duration-200 max-h-[85vh] overflow-y-auto no-scrollbar flex flex-col">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2"><FolderOpen className="w-5 h-5 text-blue-500"/>我的行程 ({savedPlans.length})</h2>
                            <button onClick={() => setShowHistory(false)} className="p-2 bg-gray-50 rounded-full text-gray-400 hover:bg-gray-100"><X className="w-5 h-5" /></button>
                        </div>
                        {savedPlans.length === 0 ? (
                            <div className="flex-1 flex flex-col items-center justify-center text-gray-300 py-10">
                                <FolderOpen className="w-12 h-12 mb-2 opacity-50"/>
                                <p className="text-sm">暂无保存的行程</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {savedPlans.map(p => (
                                    <div key={p.id} className="bg-gray-50 p-4 rounded-2xl border border-gray-100 flex items-center justify-between group">
                                        <div className="flex-1 min-w-0 mr-4">
                                            {editingPlanId === p.id ? (
                                                <div className="flex items-center gap-2">
                                                    <input value={editTitle} onChange={(e) => setEditTitle(e.target.value)} className="w-full bg-white px-2 py-1 rounded border border-blue-200 text-sm font-bold" autoFocus />
                                                    <button onClick={(e) => saveRename(e, p.id)} className="p-1.5 bg-green-50 text-green-600 rounded-lg"><Check className="w-4 h-4"/></button>
                                                </div>
                                            ) : (
                                                <div><h3 className="font-bold text-gray-800 text-sm truncate">{p.title}</h3><p className="text-[10px] text-gray-400 mt-1">{p.startPoint} <ArrowRight className="w-3 h-3 inline"/> {p.endPoint} · {p.durationDays}天</p></div>
                                            )}
                                        </div>
                                        <div className="flex items-center gap-1">
                                            {editingPlanId !== p.id && (<button onClick={(e) => startRenaming(e, p)} className="p-2 text-gray-400 hover:text-blue-500 bg-white rounded-xl shadow-sm"><Edit3 className="w-4 h-4"/></button>)}
                                            <button onClick={() => loadPlan(p)} className="p-2 text-blue-600 bg-blue-50 rounded-xl font-bold shadow-sm"><Play className="w-4 h-4 fill-current"/></button>
                                            <button onClick={(e) => deletePlan(e, p.id)} className="p-2 text-red-400 hover:text-red-600 bg-white rounded-xl shadow-sm"><Trash2 className="w-4 h-4"/></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                 </div>
              )}

              {showSettings && (
                <div className="fixed inset-0 bg-black/50 backdrop-blur-sm z-[100] flex items-center justify-center p-6 animate-in fade-in duration-200 safe-top safe-bottom">
                  <div className="bg-white w-full rounded-[32px] p-6 shadow-2xl animate-in zoom-in-95 duration-200 max-h-[85vh] overflow-y-auto no-scrollbar">
                    <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-gray-800">设置</h2><button onClick={() => setShowSettings(false)} className="p-2 bg-gray-50 rounded-full text-gray-400 hover:bg-gray-100"><X className="w-5 h-5" /></button></div>
                    <div className="space-y-6">
                      <div className="space-y-3 pb-6 border-b border-gray-100">
                        <h3 className="text-sm font-bold text-orange-600 uppercase tracking-widest flex items-center gap-2"><Wallet className="w-4 h-4"/> 默认预算偏好</h3>
                        <div>
                            <label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">酒店每晚预算</label>
                            <div className="relative"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">¥</span><input type="number" value={settings.defaultHotelBudget} onFocus={(e) => e.target.select()} onChange={(e) => setSettings({...settings, defaultHotelBudget: parseInt(e.target.value) || 0})} className="w-full pl-8 pr-4 py-3 bg-gray-50 rounded-xl border border-transparent focus:border-orange-500 focus:bg-white outline-none transition-all text-sm font-medium" /></div>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <div><label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">人均餐饮/餐</label><div className="relative"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">¥</span><input type="number" value={settings.defaultDiningPerPerson} onFocus={(e) => e.target.select()} onChange={(e) => setSettings({...settings, defaultDiningPerPerson: parseInt(e.target.value) || 0})} className="w-full pl-8 pr-4 py-3 bg-gray-50 rounded-xl border border-transparent focus:border-orange-500 focus:bg-white outline-none transition-all text-sm font-medium" /></div></div>
                            <div><label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">总餐饮预算</label><div className="relative"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">¥</span><input type="number" value={settings.defaultDiningTotal} onFocus={(e) => e.target.select()} onChange={(e) => setSettings({...settings, defaultDiningTotal: parseInt(e.target.value) || 0})} className="w-full pl-8 pr-4 py-3 bg-gray-50 rounded-xl border border-transparent focus:border-orange-500 focus:bg-white outline-none transition-all text-sm font-medium" /></div></div>
                        </div>
                      </div>
                      <div className="space-y-3">
                        <h3 className="text-sm font-bold text-blue-600 uppercase tracking-widest">AI 配置 (Gemini)</h3>
                        <div><label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">API Key</label><input type="password" value={settings.apiKey} onChange={(e) => setSettings({...settings, apiKey: e.target.value})} className="w-full px-4 py-3 bg-gray-50 rounded-xl border border-transparent focus:border-blue-500 focus:bg-white outline-none transition-all text-sm font-medium" /></div>
                        <div><label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Base URL</label><input type="text" value={settings.baseUrl} onChange={(e) => setSettings({...settings, baseUrl: e.target.value})} className="w-full px-4 py-3 bg-gray-50 rounded-xl border border-transparent focus:border-blue-500 focus:bg-white outline-none transition-all text-sm font-medium" /></div>
                        <div><label className="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Model</label><input type="text" value={settings.model} onChange={(e) => setSettings({...settings, model: e.target.value})} className="w-full px-4 py-3 bg-gray-50 rounded-xl border border-transparent focus:border-blue-500 focus:bg-white outline-none transition-all text-sm font-medium" /></div>
                      </div>
                      <button onClick={saveSettings} className="w-full bg-blue-600 text-white font-bold py-3.5 rounded-2xl shadow-lg shadow-blue-200 active:scale-95 transition-all mt-4">保存设置</button>
                    </div>
                  </div>
                </div>
              )}

              {/* BUG 2 FIX: Lightbox is now fixed over the entire viewport, not relative to scroll */}
              {lightboxImage && (
                <div className="fixed inset-0 bg-black z-[200] flex items-center justify-center animate-in fade-in duration-200 touch-none" onClick={() => setLightboxImage(null)}>
                   <img src={lightboxImage} alt="Full View" className="max-w-full max-h-full object-contain" />
                   <button className="absolute top-4 right-4 text-white p-2 bg-white/10 rounded-full safe-top"><X className="w-6 h-6"/></button>
                </div>
              )}

                <section className="p-4">
                  <div className="bg-white rounded-[32px] shadow-sm border border-gray-100 overflow-hidden">
                    <button onClick={() => setIsFormExpanded(!isFormExpanded)} className="w-full px-6 py-4 flex items-center justify-between text-gray-700 font-bold">
                      <div className="flex items-center gap-2"><Search className="w-4 h-4 text-blue-500" /><span>{plan ? plan.title : "规划你的旅程"}</span></div>
                      {isFormExpanded ? <ChevronUp className="w-5 h-5" /> : <ChevronDown className="w-5 h-5" />}
                    </button>
                    {isFormExpanded && (
                      <div className="px-6 pb-6 space-y-5 animate-in slide-in-from-top-2 duration-300">
                        <div className="space-y-4">
                           <div className="flex gap-3">
                            <div className="flex-1 relative">
                              <MapPin className="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-blue-500" />
                              <input value={start} onChange={e => setStart(e.target.value)} className="w-full pl-11 pr-4 py-3 bg-gray-50 rounded-2xl border-none outline-none text-sm font-medium" placeholder="起点" />
                              <button onClick={handleLocateMe} className="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-blue-50 rounded-xl text-blue-600 hover:bg-blue-100 transition-colors">
                                {isLocating ? <Loader2 className="w-4 h-4 animate-spin"/> : <LocateFixed className="w-4 h-4"/>}
                              </button>
                            </div>
                          </div>
                          <div className="flex-1 relative"><MapPin className="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-red-500" /><input value={end} onChange={e => setEnd(e.target.value)} className="w-full pl-11 pr-4 py-3 bg-gray-50 rounded-2xl border-none outline-none text-sm font-medium" placeholder="终点" /></div>
                          {!isLoadingRecs && recommendedDestinations.length > 0 && (
                            <div className="flex flex-wrap gap-2 animate-in fade-in slide-in-from-top-2">
                              <span className="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex items-center h-6">周边好去处 ({'>'}300km):</span>
                              {recommendedDestinations.map(city => (
                                <button key={city} onClick={() => setEnd(city)} className="px-3 py-1 bg-orange-50 text-orange-600 rounded-lg text-xs font-bold border border-orange-100 transition-colors hover:bg-orange-100">{city}</button>
                              ))}
                            </div>
                          )}
                        </div>
                        <div className="h-px bg-gray-100 w-full" />
                        
                        <div className="space-y-2"><label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1"><Clock className="w-3 h-3" />出发时间</label><input type="datetime-local" value={startTime} onChange={e => handleStartTimeChange(e.target.value)} className="w-full px-4 py-3 bg-gray-50 rounded-2xl border-none outline-none text-sm font-medium" /><QuickTimeButtons target="start" /></div>

                        <div className="space-y-2">
                            <label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1"><Users className="w-3 h-3" />出行人数</label>
                            <div className="flex items-center justify-between bg-gray-50 p-1 rounded-2xl">
                              <button onClick={() => setTravelers(Math.max(1, travelers - 1))} className="p-3 hover:bg-white rounded-xl transition-all shadow-sm"><Minus className="w-4 h-4" /></button>
                              <span className="font-bold text-gray-800">{travelers} 人</span>
                              <button onClick={() => setTravelers(travelers + 1)} className="p-3 hover:bg-white rounded-xl transition-all shadow-sm"><Plus className="w-4 h-4" /></button>
                            </div>
                        </div>

                        <div className="space-y-2">
                            <label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">游玩天数</label>
                            <div className="flex items-center justify-between bg-gray-50 p-1 rounded-2xl">
                              <button onClick={() => handleDaysChange(Math.max(1, days - 1))} className="p-2 hover:bg-white rounded-xl transition-all"><Minus className="w-4 h-4" /></button>
                              <span className="font-bold text-blue-600">{days} 天</span>
                              <button onClick={() => handleDaysChange(days + 1)} className="p-2 hover:bg-white rounded-xl transition-all"><Plus className="w-4 h-4" /></button>
                            </div>
                        </div>

                         <div className="space-y-2"><label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1"><Watch className="w-3 h-3" />结束时间</label><input type="datetime-local" value={endTime} onChange={e => handleEndTimeChange(e.target.value)} className="w-full px-4 py-3 bg-gray-50 rounded-2xl border-none outline-none text-sm font-medium" /><QuickTimeButtons target="end" /></div>

                        <div className="grid grid-cols-1 gap-4 pt-2 border-t border-gray-50">
                          <div className="space-y-2">
                             <label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1"><Heart className="w-3 h-3 text-red-500" />添加 (必去景点/门店)</label>
                             <div className="flex gap-2"><input value={mustVisitInput} onChange={e => setMustVisitInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && addMustVisit()} className="flex-1 px-4 py-2 bg-gray-50 rounded-xl text-sm border-none outline-none" placeholder="输入名称..." /><button onClick={addMustVisit} className="px-4 bg-red-50 text-red-600 rounded-xl font-bold text-sm hover:bg-red-100"><Plus className="w-4 h-4"/></button></div>
                             <div className="flex flex-wrap gap-2">{mustVisitList.map((item, i) => (<span key={i} className="inline-flex items-center gap-1 px-2 py-1 bg-red-50 text-red-600 rounded-lg text-xs font-bold border border-red-100">{item} <X className="w-3 h-3 cursor-pointer" onClick={() => removeMustVisit(i)} /></span>))}</div>
                          </div>

                           <div className="space-y-2">
                             <label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1"><AlertTriangle className="w-3 h-3 text-gray-500" />避雷 (不去/拉黑)</label>
                             <div className="flex gap-2"><input value={avoidInput} onChange={e => setAvoidInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && addAvoid()} className="flex-1 px-4 py-2 bg-gray-50 rounded-xl text-sm border-none outline-none" placeholder="输入名称/城市..." /><button onClick={addAvoid} className="px-4 bg-gray-100 text-gray-600 rounded-xl font-bold text-sm hover:bg-gray-200"><Plus className="w-4 h-4"/></button></div>
                             <div className="flex flex-wrap gap-2">{avoidList.map((item, i) => (<span key={i} className="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-500 rounded-lg text-xs font-bold border border-gray-200">{item} <X className="w-3 h-3 cursor-pointer" onClick={() => removeAvoid(i)} /></span>))}</div>
                          </div>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                          <div className="space-y-2"><label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">行程模式</label><button onClick={() => setIsRoundTrip(!isRoundTrip)} className={`w-full py-3 rounded-2xl text-xs font-bold transition-all ${isRoundTrip ? 'bg-blue-600 text-white shadow-lg shadow-blue-100' : 'bg-gray-100 text-gray-400'}`}>{isRoundTrip ? '往返路线' : '单程路线'}</button></div>
                          <div className="space-y-2"><label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest">游玩节奏</label><div className="flex bg-gray-100 p-1 rounded-2xl h-[42px]">{Object.values(Pacing).map(p => (<button key={p} onClick={() => setPacing(p)} className={`flex-1 text-[10px] font-bold rounded-xl transition-all ${pacing === p ? 'bg-white text-blue-600 shadow-sm h-full' : 'text-gray-400'}`}>{p}</button>))}</div></div>
                        </div>

                        <div className="pt-2 border-t border-gray-50 space-y-4">
                            <label className="text-[10px] font-bold text-gray-400 uppercase tracking-widest flex items-center gap-1"><ChefHat className="w-3 h-3 text-orange-500" />餐饮预算设置</label>
                            <div className="bg-orange-50/50 p-4 rounded-2xl space-y-4">
                                <div className="flex bg-white p-1 rounded-xl shadow-sm">
                                    <button onClick={() => setDiningMode(DiningMode.PER_MEAL)} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${diningMode === DiningMode.PER_MEAL ? 'bg-orange-500 text-white shadow-md' : 'text-gray-400'}`}>人均/餐</button>
                                    <button onClick={() => setDiningMode(DiningMode.TOTAL)} className={`flex-1 py-2 text-xs font-bold rounded-lg transition-all ${diningMode === DiningMode.TOTAL ? 'bg-orange-500 text-white shadow-md' : 'text-gray-400'}`}>总预算控制</button>
                                </div>
                                {diningMode === DiningMode.PER_MEAL ? (
                                    <div className="space-y-2 animate-in fade-in">
                                        <div className="flex justify-between text-xs font-bold text-gray-500"><span>每餐人均</span><span className="text-orange-600">￥{diningPerPerson}</span></div>
                                        <input type="range" min="30" max="600" step="10" value={diningPerPerson} onChange={e => setDiningPerPerson(Number(e.target.value))} className="w-full h-2 bg-gray-200 rounded-full appearance-none accent-orange-500" />
                                        <p className="text-[10px] text-gray-400 text-center">AI 将尽量推荐人均接近此价格的餐厅</p>
                                    </div>
                                ) : (
                                    <div className="space-y-2 animate-in fade-in">
                                        <div className="flex justify-between text-xs font-bold text-gray-500"><span>行程总餐饮预算 (含{travelers}人)</span></div>
                                        <div className="relative"><span className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400 font-bold">￥</span><input type="number" value={diningTotal} onFocus={(e) => e.target.select()} onChange={e => setDiningTotal(Number(e.target.value))} className="w-full pl-8 pr-4 py-2 bg-white border border-orange-200 rounded-xl text-sm font-bold text-orange-600 outline-none custom-input" /></div>
                                        <p className="text-[10px] text-orange-600 leading-tight">💡 智能策略：平时安排高性价比简餐，在关键时刻安排<b>高档/黑珍珠餐厅</b>，确保总花费不超标。</p>
                                    </div>
                                )}
                            </div>
                        </div>

                        <div className="pt-2 border-t border-gray-50 space-y-4">
                          <div className="flex items-center justify-between"><span className="text-sm font-bold text-gray-700">自动规划住宿</span><button onClick={() => setIncludeAccom(!includeAccom)} className={`w-12 h-6 rounded-full transition-colors relative ${includeAccom ? 'bg-blue-600' : 'bg-gray-200'}`}><div className={`absolute top-1 w-4 h-4 bg-white rounded-full transition-transform ${includeAccom ? 'translate-x-7' : 'translate-x-1'}`} /></button></div>
                          {includeAccom && (
                            <div className="space-y-4 animate-in fade-in duration-300">
                              <div className="flex bg-gray-100 p-1 rounded-2xl"><button onClick={() => setAccommodationType(AccommodationType.HOTEL)} className={`flex-1 py-2 text-xs font-bold rounded-xl transition-all ${accommodationType === AccommodationType.HOTEL ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-400'}`}>酒店</button><button onClick={() => setAccommodationType(AccommodationType.CAR)} className={`flex-1 py-2 text-xs font-bold rounded-xl transition-all ${accommodationType === AccommodationType.CAR ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-400'}`}>车住(床车)</button></div>
                              {accommodationType === AccommodationType.HOTEL && (<div className="space-y-2"><div className="flex justify-between text-[10px] font-bold text-gray-400"><span>每晚预算</span><span className="text-blue-600">￥{hotelBudget}</span></div><input type="range" min="100" max="2000" step="100" value={hotelBudget} onChange={e => setHotelBudget(Number(e.target.value))} className="w-full h-1 bg-gray-200 rounded-full appearance-none accent-blue-600" /></div>)}
                              {accommodationType === AccommodationType.CAR && (
                                  <div className="bg-blue-50 p-3 rounded-xl text-[10px] text-blue-600 leading-relaxed border border-blue-100"><div className="flex items-center gap-1 font-bold mb-1"><Car className="w-3 h-3"/> 床车模式已开启</div>AI 将优先寻找<b>免费/便宜的地下停车场</b>（冬暖夏凉）或24h公共停车场。已屏蔽房车营地。</div>
                              )}
                            </div>
                          )}
                        </div>
                        <button onClick={handleGenerate} disabled={isLoading} className="w-full bg-blue-600 text-white font-bold py-4 rounded-3xl flex flex-col items-center justify-center gap-1 shadow-xl shadow-blue-100 active:scale-95 transition-all disabled:opacity-50">
                            <div className="flex items-center gap-2">
                                {isLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : <Navigation className="w-5 h-5 fill-current" />}
                                <span>{isLoading ? "规划方案中..." : "生成智能自驾路线"}</span>
                            </div>
                            {isLoading && (
                                <span className={`text-[10px] opacity-80 ${!isLocked ? 'text-yellow-200 font-bold animate-pulse' : 'animate-pulse-slow'}`}>
                                    {isLocked ? "屏幕已常亮" : "⚠️ 请手动保持屏幕常亮"}
                                </span>
                            )}
                        </button>
                      </div>
                    )}
                  </div>
                </section>

                {plan && viewMode === 'list' && (
                  <div className="px-5 space-y-8 mt-4 animate-in slide-in-from-bottom-4 duration-500">
                    {plan.days.map((day, dIdx) => (
                      <div key={dIdx} className="space-y-6">
                        <div className="flex items-center gap-3 justify-between">
                          <div className="flex items-center gap-3"><div className="w-12 h-12 bg-gray-800 text-white rounded-2xl flex items-center justify-center font-bold text-lg shadow-lg">D{day.day}</div><div><h3 className="font-bold text-gray-800">{day.date}</h3><p className="text-[10px] text-gray-400 font-bold uppercase tracking-widest">行程概要</p></div></div>
                          {day.transportation_cost && (<div className="text-right"><span className="block text-[10px] text-gray-400 font-bold uppercase">预计路费</span><span className="text-xs font-bold text-gray-700 bg-gray-100 px-2 py-1 rounded-lg">{day.transportation_cost}</span></div>)}
                        </div>
                        <div className="relative ml-6 pl-8 border-l-2 border-dashed border-gray-200 space-y-8">
                          {day.points.map((pt, pIdx) => {
                            const pointCost = calculatePointCost(pt, plan.travelers);
                            const cardImages = getRealImages(pt.name, pt.type);
                            return (
                            <div key={pIdx} className="relative">
                              <div className={`absolute -left-[45px] top-1 w-8 h-8 rounded-full border-4 border-white shadow-md z-10 flex items-center justify-center ${pt.type === 'restaurant' ? 'bg-orange-500' : pt.type === 'parking' ? 'bg-indigo-600' : 'bg-blue-600'}`}>{pt.type === 'restaurant' ? <Utensils className="w-4 h-4 text-white" /> : <MapPin className="w-4 h-4 text-white" />}</div>
                              <div onClick={() => handlePointClick(pt)} className="bg-white p-5 rounded-[32px] shadow-sm border border-gray-100 hover:border-blue-200 transition-all cursor-pointer group">
                                <div className="flex justify-between items-start mb-2"><div><span className="text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-lg">{pt.arrivalTime} 到达</span><h4 className="font-bold text-gray-800 text-base mt-2 group-hover:text-blue-600 transition-colors">{pt.name}</h4></div><button onClick={(e) => handleReplaceClick(e, pt, dIdx, pIdx)} className="p-2 text-gray-300 hover:text-blue-600 hover:bg-blue-50 rounded-xl transition-all"><RefreshCw className={`w-4 h-4 ${!pt.alternatives ? 'opacity-50' : ''}`} /></button></div>
                                <div className="grid grid-cols-4 gap-2 mb-3 h-16 w-full">{cardImages.map((imgUrl, i) => (<div key={i} className="relative w-full h-full rounded-xl overflow-hidden bg-gray-100" onClick={(e) => { e.stopPropagation(); setLightboxImage(imgUrl); }}><img src={imgUrl} loading="lazy" className="w-full h-full object-cover transform hover:scale-110 transition-transform duration-500" alt={`${pt.name} ${i}`} onError={(e) => { (e.target).src = 'https://via.placeholder.com/400x300?text=Image+Unavailable'; }} /></div>))}</div>
                                <div className="flex gap-2 mb-3 flex-wrap">{pt.duration && (<span className="inline-flex items-center gap-1 text-[10px] font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded-md"><Clock className="w-3 h-3" /> {pt.duration}</span>)}{pointCost > 0 && (<span className="inline-flex items-center gap-1 text-[10px] font-bold text-yellow-600 bg-yellow-50 px-2 py-1 rounded-md"><Receipt className="w-3 h-3" /> 小计: ¥{pointCost}</span>)}</div>
                                <p className="text-xs text-gray-500 leading-relaxed line-clamp-2">{pt.description}</p>
                                <div className="flex items-center gap-4 mt-4 pt-4 border-t border-gray-50"><div className="flex items-center gap-1 text-xs text-orange-500 font-bold"><Star className="w-3 h-3 fill-current" /><span>{pt.rating}</span></div><span className="text-[10px] text-gray-400 font-medium">({pt.user_ratings_total} 评价)</span>{pt.travelTimeToNext && (<div className="ml-auto text-[10px] font-bold text-gray-400 flex items-center gap-1"><ArrowRight className="w-3 h-3" /> 行驶 {pt.travelTimeToNext}</div>)}</div>
                              </div>
                            </div>
                          )})}
                        </div>
                      </div>
                    ))}
                    <CostSummary plan={plan} />
                  </div>
                )}

                {viewMode === 'map' && (
                  <div className="fixed inset-0 z-40 bg-gray-100 flex flex-col safe-top safe-bottom">
                    {plan && plan.days.length > 0 ? (<iframe src={getMapSrc()} className="w-full h-full border-0" allowFullScreen loading="lazy" title="Google Maps Route"/>) : (<div className="flex items-center justify-center h-full text-gray-400">暂无路线数据</div>)}
                    <button onClick={() => setViewMode('list')} className="absolute top-6 right-6 w-10 h-10 bg-white rounded-full flex items-center justify-center shadow-lg text-gray-600 safe-top"><X className="w-5 h-5" /></button>
                  </div>
                )}
                
                {/* Modals for Point Detail & Alternatives - Fixed relative to window */}
                {selectedPoint && !showAlternatives && (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-md z-[110] flex items-center justify-center p-6 animate-in fade-in duration-200 safe-top safe-bottom">
                  <div className="bg-white w-full h-[85vh] rounded-[48px] overflow-hidden shadow-2xl animate-in slide-in-from-bottom-10 duration-300 flex flex-col">
                      <div className="relative h-64 bg-gray-100 flex-shrink-0">
                        {(() => {
                          const displayPhotos = (selectedPoint.photos && selectedPoint.photos.length > 0) ? selectedPoint.photos : getRealImages(selectedPoint.name, selectedPoint.type);
                          return (
                            <div className="w-full h-full flex overflow-x-auto no-scrollbar snap-x snap-mandatory">
                              {displayPhotos.map((url, i) => (<div key={i} className="w-full h-full flex-shrink-0 snap-center relative" onClick={() => setLightboxImage(url)}><img src={url} className="w-full h-full object-cover" alt={`Photo ${i}`} onError={(e) => { (e.target).src = 'https://via.placeholder.com/800x600?text=Image+Unavailable'; }} /><div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black/30 rounded-full p-2 opacity-0 hover:opacity-100 transition-opacity pointer-events-none"><Maximize2 className="w-8 h-8 text-white"/></div></div>))}
                              <div className="absolute bottom-4 right-4 bg-black/50 text-white text-xs px-2 py-1 rounded-lg backdrop-blur-sm flex items-center gap-1 pointer-events-none"><ImageIcon className="w-3 h-3"/> {displayPhotos.length} 张图片 (点击查看)</div>
                            </div>
                          );
                        })()}
                      <button onClick={() => setSelectedPoint(null)} className="absolute top-6 right-6 w-10 h-10 bg-white/20 backdrop-blur-md rounded-full flex items-center justify-center text-white border border-white/30 hover:bg-white hover:text-gray-800 transition-all z-10"><X className="w-5 h-5"/></button>
                    </div>

                    <div className="flex-1 overflow-y-auto p-8">
                      <div className="mb-4">
                        <h3 className="text-2xl font-bold text-gray-800">{selectedPoint.name}</h3>
                        <div className="flex items-center gap-2 mt-2 flex-wrap">
                          <div className="flex items-center gap-1 text-orange-500 font-bold bg-orange-50 px-2 py-1 rounded-lg text-sm"><Star className="w-4 h-4 fill-current" /><span>{selectedPoint.rating}</span></div>
                          <span className="text-gray-400 text-sm">({selectedPoint.user_ratings_total} 条评价)</span>
                        </div>
                      </div>

                      <div className="flex gap-3 mb-6 flex-wrap">
                          {selectedPoint.duration && <div className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-xl text-xs font-medium text-gray-600"><Clock className="w-4 h-4 text-blue-500" /><span>{selectedPoint.duration}</span></div>}
                          {selectedPoint.ticket_price && <div className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-xl text-xs font-medium text-gray-600"><Ticket className="w-4 h-4 text-indigo-500" /><span>{selectedPoint.ticket_price}</span></div>}
                          {selectedPoint.average_cost && <div className="flex items-center gap-2 bg-gray-50 px-3 py-2 rounded-xl text-xs font-medium text-gray-600"><Banknote className="w-4 h-4 text-green-500" /><span>{selectedPoint.average_cost}</span></div>}
                      </div>

                      <div className="space-y-6">
                        <div><h4 className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">简介</h4><p className="text-gray-600 text-sm leading-relaxed">{selectedPoint.description}</p></div>
                        <div><h4 className="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3 flex items-center gap-2"><MessageSquare className="w-3 h-3"/> AI 推荐理由</h4>
                           <div className="text-center py-4 text-gray-400 text-xs italic bg-gray-50 rounded-2xl border border-dashed border-gray-200">此地点为 AI 根据您的喜好智能推荐，暂无实时评论。</div>
                        </div>
                      </div>
                    </div>
                    <div className="p-6 border-t border-gray-50 flex-shrink-0"><a href={`https://www.google.com/maps/search/?api=1&query=${selectedPoint.lat},${selectedPoint.lng}`} target="_blank" className="w-full bg-blue-600 text-white font-bold py-4 rounded-3xl flex items-center justify-center gap-2 shadow-xl shadow-blue-100 active:scale-95 transition-all"><Navigation className="w-5 h-5" />谷歌地图导航</a></div>
                  </div>
                </div>
              )}

              {showAlternatives && (
                <div className="fixed inset-0 bg-black/40 backdrop-blur-sm z-[120] flex items-end justify-center safe-top safe-bottom">
                  <div className="bg-white w-full rounded-t-[48px] p-8 animate-in slide-in-from-bottom-full duration-500 max-h-[80vh] overflow-y-auto no-scrollbar">
                    <div className="flex justify-between items-center mb-8"><div><h3 className="text-xl font-bold text-gray-800">更换地点</h3><p className="text-xs text-gray-400 mt-1">寻找更适合你的目的地</p></div><button onClick={() => setShowAlternatives(null)} className="p-2 bg-gray-50 rounded-full text-gray-400"><X className="w-5 h-5"/></button></div>
                    <div className="space-y-4">
                      {isLoadingAlts && alternatives.length === 0 ? (
                        <div className="py-20 flex flex-col items-center gap-4 text-gray-300"><Loader2 className="w-10 h-10 animate-spin text-blue-600" /><p className="font-bold text-sm">正在搜寻周边高分地点...</p></div>
                      ) : alternatives.map((alt, i) => (
                        <div key={i} onClick={() => confirmReplace(alt)} className="p-5 bg-gray-50 rounded-[32px] border border-transparent hover:border-blue-200 transition-all cursor-pointer flex items-center justify-between group active:scale-95">
                          <div className="flex-1 pr-4">
                            <h4 className="font-bold text-gray-800 group-hover:text-blue-600 transition-colors">{alt.name}</h4>
                            <p className="text-[10px] text-gray-400 line-clamp-1 mt-1">{alt.description}</p>
                            <div className="flex gap-2 mt-2 flex-wrap">{alt.ticket_price && <span className="text-[9px] bg-indigo-50 text-indigo-500 px-1.5 py-0.5 rounded flex items-center gap-0.5"><Ticket className="w-2 h-2"/>{alt.ticket_price}</span>}{alt.average_cost && <span className="text-[9px] bg-green-50 text-green-600 px-1.5 py-0.5 rounded flex items-center gap-0.5"><Banknote className="w-2 h-2"/>{alt.average_cost}</span>}</div>
                            <div className="flex items-center gap-2 mt-2"><div className="flex items-center gap-1 text-[10px] text-orange-500 font-bold"><Star className="w-3 h-3 fill-current" />{alt.rating}</div><span className="text-[10px] text-gray-400">({alt.user_ratings_total} 评价)</span></div>
                          </div>
                          <div className="w-10 h-10 bg-white rounded-2xl flex items-center justify-center text-blue-600 shadow-sm border border-gray-100"><Check className="w-5 h-5" /></div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}

              </main>

              {/* Navigation Bar - Absolute bottom of flex container */}
              <nav className="absolute bottom-0 left-0 right-0 max-w-md mx-auto glass border-t border-white/50 flex justify-around items-center z-[60] shadow-2xl rounded-t-[40px] footer-safe">
                <button onClick={() => plan && setViewMode('list')} className={`flex flex-col items-center gap-1 transition-all ${viewMode === 'list' ? 'text-blue-600 scale-110' : 'text-gray-400'}`}><ListIcon className="w-6 h-6" /><span className="text-[10px] font-bold uppercase">清单</span></button>
                <button onClick={() => plan && setViewMode('map')} className={`flex flex-col items-center gap-1 transition-all ${viewMode === 'map' ? 'text-blue-600 scale-110' : 'text-gray-400'}`}><MapIcon className="w-6 h-6" /><span className="text-[10px] font-bold uppercase">地图</span></button>
                <button onClick={saveCurrentPlan} className="flex flex-col items-center gap-1 text-gray-400 hover:text-blue-600 transition-colors"><Save className="w-6 h-6" /><span className="text-[10px] font-bold uppercase">保存</span></button>
              </nav>

            </div>
          );
        };

        const rootElement = document.getElementById('root');
        if (!rootElement) {
          throw new Error("Could not find root element to mount to");
        }

        if (!window.reactRoot) {
            window.reactRoot = ReactDOM.createRoot(rootElement);
        }
        
        window.reactRoot.render(
          <React.StrictMode>
            <App />
          </React.StrictMode>
        );
    </script>
</body>
</html>
